---
title: "ESFT Manual"
author: "Ines Gerard-Ursin"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{ESFT Manual}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---
```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(esft)
```

# Overview

The goal for this vignette is to be stand alone documentation so that you do not have to open up any other vignette or document in order to run the full set of analyses.

I hope to additionally add vignettes with sources, greater details, and explanations of equations, so that if any further questions arise, they can help answer them, or provide greater detail on customizing the outputs.\

### Package build warning

There is one overlapping function between two
of the dependencies that are loaded. This
warning can be ignored:

```
replacing previous import ‘dplyr::last’ by ‘data.table::last’ when loading ‘esft’

```

## Order of calculations

1.  *User input*

Here the user would specify the same items that are in the User Input tab of the ESFT excel file, which would include the country, the forecast period, the first date of the forecast, and potentially the delivery lead time (although that is currently) not included. Note: the time period for which we can forecast is between `2020-01-01` to `2022-12-31`, and is limited to the countries for which have model fits. 

2.  *Load data*

Using the data loaded with the package, subset according to country name and transmission scenario. 

3.  *Parameter setting*

This category of calculations refers to the universal parameters that stay the same across groups of countries, and tend to be based either on collated clinical opinion, on available literature, or estimates from available data.

4.  *Capacity mapping*

This category refers to estimates based on data collated from various sources, that is country specific. Where recent or country-specific estimates are not available, this group of calculations tends to provide estimates based on the World Bank income group to which the specified country belongs.

5.  *Weekly summaries*

This includes summaries of cases, health care workers, tests, and patients per week. In short, these are 'people' calculations.

6.  *Forecasts*

These are 'object' calculations. This includes commodity forecasts (which includes hygiene, case management, PPE, and diagnostic commodities), pharmaceutical forecasts, and non-COVID 19 essential equipment forecasts.

**Right now** there is no option for users to input existing equipment or capacity.

## User Input

Here we set the user inputs and country specified. Note there is an option to manually specify the country code in most calculations, but this helps for consistency/clarity.

```{r userinput}
user <- user_input()

# we set the country to be afghanistan
country <- "AFG"

```

## Load Data

So here you could either load the data from the package or download it directly from github. 

For loading it from the package, the easiest is to lazy load the actual dataset and then subset by the country code and the transmission scenario (High, low, or medium). Unfortunately you need to "translate" the transmission scenario from laymans terms into the label it has on the website. 
**I might want to add a translation function**

```{r load_data_package}
# loads data
data(icl_data, package = "esft")

# subsets by country
data <- subset(icl_data, icl_data$iso3c == country)

scenario_label <-
    transmission_scenarios$imperial_category_labels[transmission_scenarios$imperial_scenario == user$scenario]

data <- subset(data, data$scenario == scenario_label)
```

The alternate route is to download the dataset from github. Scenario will default to medium. This contains the death calibrated data. **ASK SOMEONE SPECIFICALLY ABOUT THE DIFFERENCES** - its the differences between the all.Rds file downloaded from that repo

```{r download_data, eval=FALSE}
downloaded_data <- load_imperial_data(country_code == country)

```

## Parameter Setting

We then obtain the parameters. We can manually set any parameters by passing a named list of parameters we would like to use to any of the functions, which we name `overrides`. 

```{r params}

# This is the standard list of all parameters, many from inputs tab of excel sheet
params <- get_parameters()

# Testing strategy parameters - population level testing parameters (i.e. percent tested)
test_strat <- set_testing_strategy()

# Diagnostic parameters - individual level testing parameters (i.e. number of tests per case per diagnosis, etc.)
test_params <- get_diagnostic_parameters()

# Diagnostic lab parameters - number of lab staff per lab, safety boxes per unit, etc.
lab_params <- get_lab_parameters()
```

Example of how to pass overriding parameters to the functions.
```{r overrides, eval=FALSE}
# initialising list in the function call
params <- get_parameters(overrides=list(stay_mild=3,
                                        o2_flow_sev = 5)
                         )
# initialising list outside the function call (if many parameters to be overridden)
overrides <- list(perc_crit_inv_mv = 0.3)
params <- get_parameters(overrides)
```
\
## Capacity Mapping

Once we get the parameters, it's time to use the country specified and some pre-loaded datasets to calculate basically how many machines each country already has and thus how many tests they can process. 

It is not strictly necessary to calculate capacity after setting the parameters, but thematically it makes sense to start with broad parameter setting and then drill down into country specific details.

```{r capacity}
# load data for the diagnostic capacity functions
data(throughput, package = "esft")
data(hours_per_shift, package = "esft")

# This functions pulls in data from the UN, the World Bank, the WHO, Imperial College London to collect country wide parameters which include population, number of HCWs, number of lab staff, etc. 
capacity <- get_country_capacity(iso3c=country)

# This subsets the diagnostics dataframe to find the baseline estimates of diagnostic testing capacity provided in the WHO ESFT, in terms of number of modules (which are sub units of machines) activated for COVID-19 test processing.
country_test_capacity <- get_country_test_capacity(iso3c=country)

# This function then translates modules activated to total tests and total tests for COVID-19 that can be processed per day, given assumptions about hours per shift, number of shifts a day, how many tests can be processed in different shifts, how much the machines capacity are allocated to COVID-19 processing.  
diagnostic_capacity <- calc_diagnostic_capacity(country_diagnostic_capacity =
                                                  country_test_capacity,
                                                throughput, hours_per_shift =
                                                  hours_per_shift,
                                                shifts_per_day = 1)

# Calculates the total labs available for COVID-19 given the diagnostic capacity (number of modules and machines) available
t_labs <- total_labs(diagnostic_capacity)

# Uses the country specific diagnostic capacity estimates to calculate the max number of tests per day.
max_tests <- max_tests_per_day(diagnostic_capacity)
```

## UP TO HERE - but there's still a bit to double check
## Weekly Summaries

```{r summaries}
data(hwfe, package = "esft")

cases <- cases_weekly(params, capacity, test_strategy_params=test_strat,
                      data=afg_data)

# note - error occurred when subset by date like this: afg_data$date > as.Date("2022-01-01"))
# have to subset before or you get carried over values from discharged and occupancy
cases <- subset(cases, cases$week_ends > as.Date("2022-01-01"))

# but patients still gives weird values for stay - it gives zeros, since those conditions havent been found and theyre super recursively difficlt to solve
patients <- patients_weekly(params, capacity, data = cases)
caps <- list(
  hcws_inpatients_cap = 5448,
  hcws_screening_cap = 919
)
patients <- patients[c(2:13),]
# subsetting gets the per bed stuff correct
# but the cleaner cap is sitll shit
hcw_caps <- hcw_caps(params,capacity,throughput,hwfe, patients, overrides=caps)
# also did weird stuff when subset by date - but tend only to be for diagnosis
# patients <- subset(patients, patients$week_ends > as.Date("2022-01-01"))

tests <- diagnostics_weekly(params = params, patients, cases,
                            diagnostic_parameters = test_params,
                            testing_scenario = test_strat)
# NOTE: THERE IS AN ERROR IN THE WAY HCW CAPS ARE CALCULATED IN THE ESFT SHEET

hcws <- hcws_weekly(params, # from get_parameters
                    capacity, # from get_country_capacity
                    lab_params, # get_lab_parameters
                    tests, # from diagnostics_weekly
                    patients, # patients_weekly
                    t_labs, # total_labs
                    hcw_caps)
screening_hcws <- screening_hcws_weekly(tests, hcw_caps,
                                        capacity)
added_tests <- additional_testing(hcws, # from hcws_weekly
                                  screening_hcws, # from screening_hcws_weekly
                                  test_strat, # from set_testing_strategy
                                  tests)
n_tests <- total_tests(tests, added_tests, max_tests)
test_ratios <- test_ratio(diagnostic_capacity, test_params)
```

\
## Forecasts

```{r forecasts}
ref_hcws <- reference_hcw(iso3c = "AFG", params, who, throughput,
                          default = list(
                            n_docs = 8000,
                            n_nurses = 5000,
                            n_labs = 300,
                            n_midwives = 500,
                            n_dentists = 10,
                            n_physiotherapists = 50,
                            n_trad_comp_med = 4000,
                            n_chws = 245,
                            n_pharmacists = 818
                          ))
noncovid_ess <-noncovid_essentials(noncovid, ref_hcws,
                                forecast_length = 12,
                                days_week = 5)

cases <- cases[c(2:13),]
pharma <- pharma_forecast(pharmaceuticals, cases)
# hygiene is all good
hygiene <- hygiene_forecast(
  equipment, hcws, patients, cases, tests,
  screening_hcws, params
)

case_management <- case_management_forecast(equipment, patients)
case_management <- subset(case_management, case_management$week_begins < "2022-01-14")

ppe <- ppe_forecast(
  equipment, hcws, patients, cases, tests,
  screening_hcws, params
)
ppe <- subset(ppe, ppe$week_begins < "2022-01-14")

diagnostic_supplies <- diagnostics_forecast(
  lab_params, equipment, test_ratios,
  n_tests, patients
)
diagnostic_supplies <- subset(diagnostic_supplies, diagnostic_supplies$week_begins < "2022-01-14")
```
